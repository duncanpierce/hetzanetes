{{template "update-packages.yaml" .}}
runcmd:
  - curl -sfL 'https://get.k3s.io' | sh -s - server --cluster-init --disable servicelb --disable local-storage --disable-cloud-controller --kubelet-arg cloud-provider=external --flannel-backend=none --disable-network-policy
  - mkdir {{.InstallDirectory}}
  - cd {{.InstallDirectory}}
  - curl -L --remote-name-all https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz
  - tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
  - KUBECONFIG=/etc/rancher/k3s/k3s.yaml cilium install
  - kubectl create secret generic hcloud -n kube-system --from-literal=HCLOUD_TOKEN={{.HetznerApiToken}} --from-literal=HCLOUD_NETWORK={{.ClusterName}}
  - kubectl create secret generic k3s -n kube-system --from-file=K3S_TOKEN=/var/lib/rancher/k3s/server/token --from-literal=K3S_URL="https://{{template "get-private-ip-address.sh" .}}:6443"
  - docker run -v {{.InstallDirectory}}:/install -w /install duncanpierce/hetzanetes internal kustomize --name={{.ClusterName}} --pod-ip-range={{.PodIpRange}}
  - kubectl apply -k {{.InstallDirectory}}
